<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laundry Booking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f4f8;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    form {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      margin: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 15px;
    }
    select, input[type="text"], input[type="date"] {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <h1>Laundry Slot Booking</h1>
  <form id="bookingForm">
    <label>Name:
      <input type="text" id="name" required />
    </label>
    <label>Date:
      <input type="date" id="dateInput" required />
    </label>

    <label>Big Washer:
      <select id="bigWasher">
        <option value="">--Select Time Slot--</option>
      </select>
    </label>

    <label>Small Washer:
      <select id="smallWasher">
        <option value="">--Select Time Slot--</option>
      </select>
    </label>

    <label>Big Dryer:
      <select id="bigDryer">
        <option value="">--Select Time Slot--</option>
      </select>
    </label>

    <label>Small Dryer:
      <select id="smallDryer">
        <option value="">--Select Time Slot--</option>
      </select>
    </label>

    <button type="submit">Book Slot</button>
    <button type="button" id="viewBookingsBtn">View All Bookings</button>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfU-aqLYHF_X0Rwv0WqZtZB_M0cdacoDg",
      authDomain: "launry-booking-h8.firebaseapp.com",
      databaseURL: "https://launry-booking-h8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "launry-booking-h8",
      storageBucket: "launry-booking-h8.appspot.com",
      messagingSenderId: "485927717258",
      appId: "1:485927717258:web:be15abc9f8cd281846e073"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const nameInput = document.getElementById("name");
    const dateInput = document.getElementById("dateInput");
    const bigWasher = document.getElementById("bigWasher");
    const smallWasher = document.getElementById("smallWasher");
    const bigDryer = document.getElementById("bigDryer");
    const smallDryer = document.getElementById("smallDryer");
    const form = document.getElementById("bookingForm");

    const slots = Array.from({length: 24}, (_, i) => {
      const hour = i % 12 === 0 ? 12 : i % 12;
      const period = i < 12 ? "AM" : "PM";
      return `${hour}:00 ${period}`;
    });

    const populateDropdown = (dropdown, booked = []) => {
      dropdown.innerHTML = '<option value="">--Select Time Slot--</option>';
      slots.forEach(slot => {
        if (!booked.includes(slot)) {
          const option = document.createElement("option");
          option.value = slot;
          option.text = slot;
          dropdown.appendChild(option);
        }
      });
    };

    const populateAllDropdowns = (bookedSlots = {}) => {
      populateDropdown(bigWasher, bookedSlots.bigWasher || []);
      populateDropdown(smallWasher, bookedSlots.smallWasher || []);
      populateDropdown(bigDryer, bookedSlots.bigDryer || []);
      populateDropdown(smallDryer, bookedSlots.smallDryer || []);
    };

    const loadBookedSlots = () => {
      const selectedDate = dateInput.value;
      const booked = { bigWasher: [], smallWasher: [], bigDryer: [], smallDryer: [] };

      onValue(ref(db, "bookings"), (snapshot) => {
        const bookings = snapshot.val() || {};
        Object.values(bookings).forEach(entry => {
          if (entry.date === selectedDate) {
            if (entry.bigWasher) booked.bigWasher.push(entry.bigWasher);
            if (entry.smallWasher) booked.smallWasher.push(entry.smallWasher);
            if (entry.bigDryer) booked.bigDryer.push(entry.bigDryer);
            if (entry.smallDryer) booked.smallDryer.push(entry.smallDryer);
          }
        });
        populateAllDropdowns(booked);
      });
    };

    // Limit selectable dates to today and tomorrow
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);

    const formatDate = (d) => d.toISOString().split('T')[0];
    dateInput.min = formatDate(today);
    dateInput.max = formatDate(tomorrow);
    dateInput.value = formatDate(today);
    loadBookedSlots();

    dateInput.addEventListener("change", loadBookedSlots);

    // Only allow one washer and one dryer selection
    const enforceOneWasherDryer = () => {
      const washers = [bigWasher, smallWasher];
      const dryers = [bigDryer, smallDryer];

      washers.forEach((dropdown, idx) => {
        dropdown.addEventListener("change", () => {
          if (dropdown.value) {
            washers[(idx + 1) % 2].value = "";
          }
        });
      });

      dryers.forEach((dropdown, idx) => {
        dropdown.addEventListener("change", () => {
          if (dropdown.value) {
            dryers[(idx + 1) % 2].value = "";
          }
        });
      });
    };
    enforceOneWasherDryer();

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const data = {
        name: nameInput.value,
        date: dateInput.value,
        bigWasher: bigWasher.value || null,
        smallWasher: smallWasher.value || null,
        bigDryer: bigDryer.value || null,
        smallDryer: smallDryer.value || null
      };
      push(ref(db, "bookings"), data).then(() => {
        alert("Booking successful!");
        form.reset();
        dateInput.value = formatDate(today);
        loadBookedSlots();
      });
    });

    document.getElementById("viewBookingsBtn").addEventListener("click", () => {
      window.location.href = "bookings.html";
    });
  </script>
</body>
</html>
